%% Script performs PCA analysis, with options to specify which features, which strains, and which light conditions to use. 
% author: @serenading Jan 2021

% TODO: manova to see if features separate more for bluelight condition, and pre vs. post stim
% TODO: manova to see if features separate more for at the species or
% strains level

clear
close all

%% Set analysis parameters
extractStamp = '20201218_184325'; % 20201218_184325 for standard feature extraction, 20210112_105808 for filtered data
n_nonFeatVar = 33; % the first n columns of the feature table that do not contain features. =23
lightCondition = 'bluelight'; % Leave empty '' to use all. 'prestim','bluelight','poststim'
classVar = {'strain_name'}; 

% Set filering parameters
strains = {'N2','CB4856','MY23','QX1410','VX34','NIC58','JU1373'}; 

feats2keep = {'Tierpsy_256'}; % Use all features if left empty. {'Tierpsy_256'} or {'feat1','feat2'}. Cell array containing features to use for analysis. 
feats2drop = {}; % {'path'};

n_subsample = NaN; % number of replicates per strain to include. Set to NaN to include all samples
n_skeletons_range = [50 22500]; % n_skeleton range to use for retaining the well. 25fps x 60s/min x 5 min x 3 worms = 22500 skeletons.

removeOutlier = true; % option to remove outlier coefficients from each PC
n_std2include = 3; % define outliers as being outside mean+/- n standard deviations. Use 3 for conservative outlier removal retaining 99.9% data. Use 10 to remove only extreme outliers.

%% Load and process features table and extract features matrix
% load
featureTable = readtable(['/Users/sding/OneDrive - Imperial College London/species/Results/fullFeaturesTable_' extractStamp '.csv']);
% filter for selected light condition
if ~isempty(lightCondition)
    fileLogInd = contains(featureTable.filename,lightCondition);
    featureTable = featureTable(fileLogInd,:);
end
% filter out files with too few skeletons
skelLogInd = featureTable.n_skeletons > n_skeletons_range(1) & featureTable.n_skeletons < n_skeletons_range(2);
featureTable = featureTable(skelLogInd,:);
% subsample data if specified
if ~isnan(n_subsample)
    featureTable = subsampleData(featureTable,n_subsample);
end
% filter featureTable based on specified strain and features
[featureTable, classLabels] = filterFeatureTable(featureTable,classVar,n_nonFeatVar,strains,strains2drop,feats2keep,feats2drop);
% add retained labels to the end of featureTable
for varCtr = 1:numel(classVar)
    var = classVar{varCtr};
    featureTable.(var) = classLabels.(var);
end
% extract featureMat
featureMat = table2array(featureTable(:, 1:end-numel(classVar)));
n_strains = numel(unique(featureTable.strain_name));

%% Analyze features with PCA
% pre-process feature matrix for PCA
[featureMat,dropLogInd] = preprocessFeatMat(featureMat);
n_feats = size(featureMat,2);
% do pca
[pc, score, ~, ~, explained] = pca(featureMat);

%% Set outliers from each PC to zero
if removeOutlier
    disp(['Removing outliers that fall outside of mean +/- ' num2str(n_std2include) ' deviations range.'])
    for PCCtr = 1:3
        coeff = score(:,PCCtr); % get coefficients for this PC
        coeffRange = [mean(coeff)-n_std2include*std(coeff), mean(coeff)+n_std2include*std(coeff)]; % get acceptable range of PC coefficients
        outlierLogInd = coeff < coeffRange(1) | coeff > coeffRange(2); % find outlier indices
        coeff(outlierLogInd) = 0; % set outlier coefficient to 0
        score(:,PCCtr) = coeff; % write back into scores
        disp([num2str(nnz(outlierLogInd)) ' outliers removed from PC ' num2str(PCCtr)])
    end
end

%% Plot first two PCs and colour by strain

% get strain logical index (range of n per strain: [222 414])
N2LogInd = strcmp(featureTable.strain_name,'N2');
CB4856LogInd = strcmp(featureTable.strain_name,'CB4856');
MY23LogInd = strcmp(featureTable.strain_name,'MY23');
QX1410LogInd = strcmp(featureTable.strain_name,'QX1410');
VX34LogInd = strcmp(featureTable.strain_name,'VX34');
NIC58LogInd = strcmp(featureTable.strain_name,'NIC58');
JU1373LogInd = strcmp(featureTable.strain_name,'JU1373');

% PC 1 and 2
figure; hold on
%
plot(score(N2LogInd,1),score(N2LogInd,2),'b*')
plot(score(CB4856LogInd,1),score(CB4856LogInd,2),'bo')
plot(score(MY23LogInd,1),score(MY23LogInd,2),'b.')
plot(score(QX1410LogInd,1),score(QX1410LogInd,2),'m*')
plot(score(VX34LogInd,1),score(VX34LogInd,2),'mo')
plot(score(NIC58LogInd,1),score(NIC58LogInd,2),'g*')
plot(score(JU1373LogInd,1),score(JU1373LogInd,2),'go')
%
xlabel(['PC1 (' num2str(round(explained(1))) ')%'])
ylabel(['PC2 (' num2str(round(explained(2))) ')%'])
legend({'N2','CB4856','MY23','QX1410','VX34','NIC58','JU1373'})
title(['PCA plot with ' num2str(n_strains) ' strains and ' num2str(n_feats) ' features'])

% PC 1 and 3
figure; hold on
%
plot(score(N2LogInd,1),score(N2LogInd,3),'b*')
plot(score(CB4856LogInd,1),score(CB4856LogInd,3),'bo')
plot(score(MY23LogInd,1),score(MY23LogInd,3),'b.')
plot(score(QX1410LogInd,1),score(QX1410LogInd,3),'m*')
plot(score(VX34LogInd,1),score(VX34LogInd,3),'mo')
plot(score(NIC58LogInd,1),score(NIC58LogInd,3),'g*')
plot(score(JU1373LogInd,1),score(JU1373LogInd,3),'go')
%
xlabel(['PC1 (' num2str(round(explained(1))) ')%'])
ylabel(['PC3 (' num2str(round(explained(2))) ')%'])
legend({'N2','CB4856','MY23','QX1410','VX34','NIC58','JU1373'})
title(['PCA plot with ' num2str(n_strains) ' strains and ' num2str(n_feats) ' features'])

% PC 2 and 3
figure; hold on
%
plot(score(N2LogInd,2),score(N2LogInd,3),'b*')
plot(score(CB4856LogInd,2),score(CB4856LogInd,3),'bo')
plot(score(MY23LogInd,2),score(MY23LogInd,3),'b.')
plot(score(QX1410LogInd,2),score(QX1410LogInd,3),'m*')
plot(score(VX34LogInd,2),score(VX34LogInd,3),'mo')
plot(score(NIC58LogInd,2),score(NIC58LogInd,3),'g*')
plot(score(JU1373LogInd,2),score(JU1373LogInd,3),'go')
%
xlabel(['PC2 (' num2str(round(explained(1))) ')%'])
ylabel(['PC3 (' num2str(round(explained(2))) ')%'])
legend({'N2','CB4856','MY23','QX1410','VX34','NIC58','JU1373'})
title(['PCA plot with ' num2str(n_strains) ' strains and ' num2str(n_feats) ' features'])

%% 3D plot of the first three PCs and colour by strain
%
figure;
%
scatter3(score(N2LogInd,1),score(N2LogInd,2),score(N2LogInd,3),'b*','LineWidth',1)
hold on
scatter3(score(CB4856LogInd,1),score(CB4856LogInd,2),score(CB4856LogInd,3),'bo','LineWidth',1)
scatter3(score(MY23LogInd,1),score(MY23LogInd,2),score(MY23LogInd,3),'b.','LineWidth',1)
scatter3(score(QX1410LogInd,1),score(QX1410LogInd,2),score(QX1410LogInd,3),'m*','LineWidth',1)
scatter3(score(VX34LogInd,1),score(VX34LogInd,2),score(VX34LogInd,3),'mo','LineWidth',1)
scatter3(score(NIC58LogInd,1),score(NIC58LogInd,2),score(NIC58LogInd,3),'g*','LineWidth',1)
scatter3(score(JU1373LogInd,1),score(JU1373LogInd,2),score(JU1373LogInd,3),'go','LineWidth',1)

%
xlabel(['PC1 (' num2str(round(explained(1))) ')%'])
ylabel(['PC2 (' num2str(round(explained(2))) ')%'])
zlabel(['PC3 (' num2str(round(explained(3))) ')%'])
%
legend({'N2','CB4856','MY23','QX1410','VX34','NIC58','JU1373'})
title(['PCA plot with ' num2str(n_strains) ' strains and ' num2str(n_feats) ' features'])
set(gca,'fontsize',15)

%% Plot variance explained as a function of number of PCs
%
figure; hold on
%
subplot(1,2,1)
plot(cumsum(explained),'o','LineWidth',2); 
xlim([0 200])
ylim([0 100]); xlabel('Number of PCs'); ylabel('Variance explained (%)');
if strcmp(feats2keep,'Tierpsy_256')
    xlim([0 80])
end
%
set(gca,'fontsize',15)
% 
subplot(1,2,2)
plot(explained,'o','LineWidth',2)
xlim([0 200])
xlabel('Number of PCs'); ylabel('Additional variance explained (%)');
%
set(gca,'fontsize',15)

%% see what's inside the first PC
% [feat,featInd] = sort(pc(:,1)); % PC1 
% featureTable.Properties.VariableNames(featInd)'

%% Clustergram
rowLabels = featureTable.strain_name;
colLabels = featureTable.Properties.VariableNames(1:end-numel(classVar));
colLabels = colLabels(~dropLogInd);
cgObj = clustergram(featureMat,'RowLabels',rowLabels,'ColumnLabels',colLabels,...
    'Colormap',redbluecmap,'ShowDendrogram','on','OptimalLeafOrder',true)

%% Results
% Good separation at the species level using PC3 with either PC1 or 2 
% elegans and tropicalis separate better from each other than they do from
% briggsae
% PC2 seems good at separating reference (*) and divergent (o) strains